---
layout: post
title: 持续交付在星辰平台的应用
category: [CD]
date: 2016-11-23
author: VERYYOUNG
comments: true
---

[上篇文章](/blog/2016/11/23/continuous-delivery-reading-note.html)提到了持续交付，使用持续交付好处诸多，这里就不说了。

其实在之前工作过程中，也尝试过 Jenkins 来做持续集成，但基本只用作自动打包，其他过程基本是 ssh 到服务器上进行人肉操作，或者完全交给 op 处理。

在星辰平台(属于滴滴效能平台部)这边用 Jenkins 做持续集成，效果还不错，同时持续交付的流程也处理得也必将棒。




<!-- more -->

### 1.代码管理
星辰平台采用了主干开发模式，即所有的代码变更和发布都在主干进行。

主干开发模式可以避免分支合并时让人抓狂的解决冲突的困境，也让持续集成变得更加及时和有效，大大提升了交付速度。

但主干开发模式最大的风险就是未完成的代码很容易被“顺带”上线，这对研发人员提出了更高的要求。
一个大任务或者 story 要切分成许多很快能完成，验收并上线的子 task，同时也要借静态代码检查、单元测试、集成测试、持续集成等来降低风险，
程序很多时候都处于中间状态，双写、新旧版本并存等都是常见的技术手段。

在必要时候需要巧妙的隐藏起来，甚至要设计很多开关，在线上的时候关掉未完成或未验收的 feature，有条件甚至可以尝试下灰度发布和 ab test。

### 2.数据库管理
在持续交付过程中，数据库管理是非常重要的环节，在多个环境间管理数据库也是一件非常麻烦是事情。

程序和数据库是强依赖的，只有做到自动化的数据库管理，持续集成才能有序的进行。

星辰平台对数据库管理有以下原则：
#### 1. 不共享数据库
公用数据库是一件很头疼的事情，很容易就会出现开发人员相互覆盖彼此所做的修改的情况，导致开发过程多次被阻断，同时排查起来困难，严重影响开发效率。

#### 2. 数据库进行版本管理
数据库最好能随着程序的交付而一起交付，并用版本控制工具管理起来。

#### 3. 不用手工变更数据库，需要使用脚本变更，并纳入版本控制

基于以上的考虑，我们引进了 [flyway](https://flywaydb.org/)，flyway 能完美满足我们上面的对数据库的要求。
有了数据库的版本控制，建立一个数据库环境非常简单了，只需建好对应的数据库，直接跑程序 run 起来，数据库结构以及一些依赖数据已经 ok 了。
对数据库有修改也非常容易，加一个 migration 脚本，所有环境都会自动执行这个变更。

### 3.静态代码检查
 


